<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZIP Form - форма создания архива</title>
    <link href="jquery-ui.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Trebuchet MS", sans-serif;
            margin: 50px;
        }
        
        .archiveHeaders {
            margin-top: 2em;
        }
        
        .archiveTextarea {
            min-width: 5in;
            min-height: 2in;
        }
    </style>

</head>

<body>
    <div>
        <h2>ZIP Form</h1>
            <div class="ui-widget">
                <p>Форма для создания архива</p>
            </div>
    </div>

    <div>
        <div>
            <h2 class="archiveHeaders">Введите данные</h2>
            <form>
                <div>
                    <textarea class="archiveTextarea" id="textArchive" rows="3" placeholder="Add text to archive"></textarea>
                </div>

                <button id="btnCreate" type="button">Create</button>
            </form>
        </div>
    </div>

    <div id="dialog" title="Generate password" style="display: none;">
        <p>Password</p>
        <input id="viewPass" type="text" value="" />
    </div>


    <script src="jquery.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script type="text/javascript" src="zip.min.js"></script>
    <script>
        async function getZipFileBlob(genPass) {
            zip.configure({
                chunkSize: 128,
                useWebWorkers: true
            });
            const zipWriter = new zip.ZipWriter(new zip.BlobWriter("application/zip"));
            await Promise.all([
                zipWriter.add("hello.txt", new zip.TextReader(jQuery("#textArchive").val()), {
                    password: genPass,
                    zipCrypto: true
                })
            ]);
            return zipWriter.close();
        }

        function downloadFile(blob) {
            const link = document.createElement("a")
            link.href = URL.createObjectURL(blob)
            link.download = "archive.zip"
            link.click()
            link.remove()
        }
        jQuery("#btnCreate").button();
        jQuery("#btnCreate").on("click", function() {

            function randomPassword() {
                var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$_+?%^&)";
                var size = 10;
                var i = 1;
                var ret = ""
                while (i <= size) {
                    $max = chars.length - 1;
                    $num = Math.floor(Math.random() * $max);
                    $temp = chars.substr($num, 1);
                    ret += $temp;
                    i++;
                }
                return ret;
            }

            var genPass = randomPassword();

            getZipFileBlob(genPass)
                .then(downloadFile);
            jQuery("#viewPass").val(genPass);
            $("#dialog").dialog("open");
            jQuery("#textArchive").val("");
        });

        $("#dialog").dialog({
            autoOpen: false,
            width: 400,
            buttons: [{
                text: "Ok",
                click: function() {
                    $(this).dialog("close");
                }
            }]
        });
    </script>

</body>

</html>